import streamlit as st

# --- Monkey-patch to suppress st.experimental_user warning ---
# We overwrite the existing deprecated attribute with the new one.
# This bypasses the warning that Streamlit emits when accessing experimental_user.
st.experimental_user = st.user
# -------------------------------------------------------------

import util.constants.filepaths
import pandas as pd
from pygwalker.api.streamlit import StreamlitRenderer, init_streamlit_comm
from util.functions.header import header

header(__file__.split('/')[-1].split('.')[0])

st.header('Ternary Complex Data Visualization')
st.write('This data explorer allows you to browse the data from all the UB-E2-E3 predicted complex structures. The dataset includes model confidence metrics, predicted binding energies, and additional features. See our paper for more details.')

# Initialize pygwalker communication
init_streamlit_comm()

# Cache the pygwalker renderer
@st.cache_resource
def get_pyg_renderer() -> "StreamlitRenderer":
    df = pd.read_csv(util.constants.filepaths.MAIN_DATASET_FILE)
    vis_spec=vis_spec = r"""{"config":[{"config":{"defaultAggregated":false,"geoms":["auto"],"coordSystem":"generic","limit":-1,"timezoneDisplayOffset":0},"encodings":{"dimensions":[{"fid":"Complex","name":"Complex","basename":"Complex","semanticType":"nominal","analyticType":"dimension","offset":0},{"fid":"E2_gene","name":"E2_gene","basename":"E2_gene","semanticType":"nominal","analyticType":"dimension","offset":0},{"fid":"E3_gene","name":"E3_gene","basename":"E3_gene","semanticType":"nominal","analyticType":"dimension","offset":0},{"fid":"E2_uniprot","name":"E2_uniprot","basename":"E2_uniprot","semanticType":"nominal","analyticType":"dimension","offset":0},{"fid":"E3_uniprot","name":"E3_uniprot","basename":"E3_uniprot","semanticType":"nominal","analyticType":"dimension","offset":0},{"fid":"linchpin","name":"linchpin","basename":"linchpin","semanticType":"nominal","analyticType":"dimension","offset":0},{"fid":"predicted_class","name":"predicted_class","basename":"predicted_class","semanticType":"quantitative","analyticType":"dimension","offset":0},{"fid":"set_id","name":"set_id","basename":"set_id","semanticType":"nominal","analyticType":"dimension","offset":0},{"fid":"predicted_label","name":"predicted_label","basename":"predicted_label","semanticType":"nominal","analyticType":"dimension","offset":0},{"fid":"gw_mea_key_fid","name":"Measure names","analyticType":"dimension","semanticType":"nominal"},{"fid":"Status","name":"Status","semanticType":"nominal","analyticType":"dimension","basename":"Status","dragId":"GW_1xbGw3Ea"},{"fid":"E3_interface_residues","name":"E3_interface_residues","semanticType":"quantitative","analyticType":"dimension","basename":"E3_interface_residues","dragId":"GW_UOITeFRp"},{"fid":"E3_interface_loops","name":"E3_interface_loops","semanticType":"quantitative","analyticType":"dimension","basename":"E3_interface_loops","dragId":"GW_PRBzJEy4"},{"fid":"E3_loop_residues","name":"E3_loop_residues","semanticType":"quantitative","analyticType":"dimension","basename":"E3_loop_residues","dragId":"GW_72mYwr3a"},{"fid":"dataset","name":"dataset","semanticType":"nominal","analyticType":"dimension","basename":"dataset","dragId":"GW_2hNQb87m"}],"measures":[{"fid":"UB_I44_E2_distance","name":"UB_I44_E2_distance","basename":"UB_I44_E2_distance","analyticType":"measure","semanticType":"quantitative","aggName":"sum","offset":0},{"fid":"Ub_Cterm_Cys_distance","name":"Ub_Cterm_Cys_distance","basename":"Ub_Cterm_Cys_distance","analyticType":"measure","semanticType":"quantitative","aggName":"sum","offset":0},{"fid":"dG_sep_AB","name":"dG_sep_AB","basename":"dG_sep_AB","analyticType":"measure","semanticType":"quantitative","aggName":"sum","offset":0},{"fid":"dG_sep_AC","name":"dG_sep_AC","basename":"dG_sep_AC","analyticType":"measure","semanticType":"quantitative","aggName":"sum","offset":0},{"fid":"dG_sep_BC","name":"dG_sep_BC","basename":"dG_sep_BC","analyticType":"measure","semanticType":"quantitative","aggName":"sum","offset":0},{"fid":"dSASA_AB","name":"dSASA_AB","basename":"dSASA_AB","analyticType":"measure","semanticType":"quantitative","aggName":"sum","offset":0},{"fid":"dSASA_AC","name":"dSASA_AC","basename":"dSASA_AC","analyticType":"measure","semanticType":"quantitative","aggName":"sum","offset":0},{"fid":"dSASA_BC","name":"dSASA_BC","basename":"dSASA_BC","analyticType":"measure","semanticType":"quantitative","aggName":"sum","offset":0},{"fid":"dSASA_hphobic_AB","name":"dSASA_hphobic_AB","basename":"dSASA_hphobic_AB","analyticType":"measure","semanticType":"quantitative","aggName":"sum","offset":0},{"fid":"dSASA_hphobic_AC","name":"dSASA_hphobic_AC","basename":"dSASA_hphobic_AC","analyticType":"measure","semanticType":"quantitative","aggName":"sum","offset":0},{"fid":"dSASA_hphobic_BC","name":"dSASA_hphobic_BC","basename":"dSASA_hphobic_BC","analyticType":"measure","semanticType":"quantitative","aggName":"sum","offset":0},{"fid":"dSASA_polar_AB","name":"dSASA_polar_AB","basename":"dSASA_polar_AB","analyticType":"measure","semanticType":"quantitative","aggName":"sum","offset":0},{"fid":"dSASA_polar_AC","name":"dSASA_polar_AC","basename":"dSASA_polar_AC","analyticType":"measure","semanticType":"quantitative","aggName":"sum","offset":0},{"fid":"dSASA_polar_BC","name":"dSASA_polar_BC","basename":"dSASA_polar_BC","analyticType":"measure","semanticType":"quantitative","aggName":"sum","offset":0},{"fid":"ipSAE_AB","name":"ipSAE_AB","basename":"ipSAE_AB","analyticType":"measure","semanticType":"quantitative","aggName":"sum","offset":0},{"fid":"ipSAE_AC","name":"ipSAE_AC","basename":"ipSAE_AC","analyticType":"measure","semanticType":"quantitative","aggName":"sum","offset":0},{"fid":"ipSAE_BC","name":"ipSAE_BC","basename":"ipSAE_BC","analyticType":"measure","semanticType":"quantitative","aggName":"sum","offset":0},{"fid":"n_hbonds_AB","name":"n_hbonds_AB","basename":"n_hbonds_AB","analyticType":"measure","semanticType":"quantitative","aggName":"sum","offset":0},{"fid":"n_hbonds_AC","name":"n_hbonds_AC","basename":"n_hbonds_AC","analyticType":"measure","semanticType":"quantitative","aggName":"sum","offset":0},{"fid":"n_hbonds_BC","name":"n_hbonds_BC","basename":"n_hbonds_BC","analyticType":"measure","semanticType":"quantitative","aggName":"sum","offset":0},{"fid":"n_res_AB","name":"n_res_AB","basename":"n_res_AB","analyticType":"measure","semanticType":"quantitative","aggName":"sum","offset":0},{"fid":"n_res_AC","name":"n_res_AC","basename":"n_res_AC","semanticType":"quantitative","analyticType":"measure","aggName":"sum","offset":0},{"fid":"n_res_BC","name":"n_res_BC","basename":"n_res_BC","analyticType":"measure","semanticType":"quantitative","aggName":"sum","offset":0},{"fid":"pDockQ2_AB","name":"pDockQ2_AB","basename":"pDockQ2_AB","analyticType":"measure","semanticType":"quantitative","aggName":"sum","offset":0},{"fid":"pDockQ2_AC","name":"pDockQ2_AC","basename":"pDockQ2_AC","analyticType":"measure","semanticType":"quantitative","aggName":"sum","offset":0},{"fid":"pDockQ2_BC","name":"pDockQ2_BC","basename":"pDockQ2_BC","analyticType":"measure","semanticType":"quantitative","aggName":"sum","offset":0},{"fid":"pDockQ_AB","name":"pDockQ_AB","basename":"pDockQ_AB","analyticType":"measure","semanticType":"quantitative","aggName":"sum","offset":0},{"fid":"pDockQ_AC","name":"pDockQ_AC","basename":"pDockQ_AC","analyticType":"measure","semanticType":"quantitative","aggName":"sum","offset":0},{"fid":"pDockQ_BC","name":"pDockQ_BC","basename":"pDockQ_BC","analyticType":"measure","semanticType":"quantitative","aggName":"sum","offset":0},{"fid":"unsat_hbonds_AB","name":"unsat_hbonds_AB","basename":"unsat_hbonds_AB","analyticType":"measure","semanticType":"quantitative","aggName":"sum","offset":0},{"fid":"unsat_hbonds_AC","name":"unsat_hbonds_AC","basename":"unsat_hbonds_AC","analyticType":"measure","semanticType":"quantitative","aggName":"sum","offset":0},{"fid":"unsat_hbonds_BC","name":"unsat_hbonds_BC","basename":"unsat_hbonds_BC","analyticType":"measure","semanticType":"quantitative","aggName":"sum","offset":0},{"fid":"predicted_probability","name":"predicted_probability","basename":"predicted_probability","analyticType":"measure","semanticType":"quantitative","aggName":"sum","offset":0},{"fid":"gw_count_fid","name":"Row count","analyticType":"measure","semanticType":"quantitative","aggName":"sum","computed":true,"expression":{"op":"one","params":[],"as":"gw_count_fid"}},{"fid":"gw_mea_val_fid","name":"Measure values","analyticType":"measure","semanticType":"quantitative","aggName":"sum"},{"fid":"ipTM_AB","name":"ipTM_AB","semanticType":"quantitative","analyticType":"measure","basename":"ipTM_AB","dragId":"GW_rB2DjAhH"},{"fid":"ipTM_AC","name":"ipTM_AC","semanticType":"quantitative","analyticType":"measure","basename":"ipTM_AC","dragId":"GW_OnLGczDr"},{"fid":"ipTM_BC","name":"ipTM_BC","semanticType":"quantitative","analyticType":"measure","basename":"ipTM_BC","dragId":"GW_J5XSGPfN"},{"fid":"UB_I44_E2_distance (angstroms)","name":"UB_I44_E2_distance (angstroms)","semanticType":"quantitative","analyticType":"measure","basename":"UB_I44_E2_distance (angstroms)","dragId":"GW_r3DZ1nOj"},{"fid":"Ub_Cterm_Cys_distance (angstroms)","name":"Ub_Cterm_Cys_distance (angstroms)","semanticType":"quantitative","analyticType":"measure","basename":"Ub_Cterm_Cys_distance (angstroms)","dragId":"GW_iyftnSZ8"}],"rows":[{"fid":"dSASA_hphobic_AB","name":"dSASA_hphobic_AB","basename":"dSASA_hphobic_AB","analyticType":"measure","semanticType":"quantitative","aggName":"sum","offset":0},{"fid":"dSASA_hphobic_AC","name":"dSASA_hphobic_AC","basename":"dSASA_hphobic_AC","analyticType":"measure","semanticType":"quantitative","aggName":"sum","offset":0}],"columns":[{"fid":"pDockQ2_AB","name":"pDockQ2_AB","basename":"pDockQ2_AB","analyticType":"measure","semanticType":"quantitative","aggName":"sum","offset":0},{"fid":"pDockQ2_AC","name":"pDockQ2_AC","basename":"pDockQ2_AC","analyticType":"measure","semanticType":"quantitative","aggName":"sum","offset":0}],"color":[{"fid":"predicted_label","name":"predicted_label","basename":"predicted_label","semanticType":"nominal","analyticType":"dimension","offset":0}],"opacity":[],"size":[],"shape":[],"radius":[],"theta":[],"longitude":[],"latitude":[],"geoId":[],"details":[],"filters":[{"fid":"dataset","name":"dataset","semanticType":"nominal","analyticType":"dimension","basename":"dataset","dragId":"GW_2hNQb87m","rule":{"type":"not in","value":["training_validation_set_pair","training_validation_set_nonpair"]}}],"text":[]},"layout":{"showActions":false,"showTableSummary":false,"stack":"stack","interactiveScale":false,"zeroScale":true,"size":{"mode":"full","width":320,"height":200},"format":{},"geoKey":"name","resolve":{"x":false,"y":false,"color":false,"opacity":false,"shape":false,"size":false},"renderer":"vega-lite"},"visId":"gw_TPXt","name":"Chart 1"}],"chart_map":{},"workflow_list":[{"workflow":[{"type":"filter","filters":[{"fid":"dataset","rule":{"type":"not in","value":["training_validation_set_pair","training_validation_set_nonpair"]}}]},{"type":"view","query":[{"op":"raw","fields":["predicted_label","pDockQ2_AB","pDockQ2_AC","dSASA_hphobic_AB","dSASA_hphobic_AC"]}]}]}],"version":"0.5.0.0"}"""

    return StreamlitRenderer(df, debug=False, appearance="light", spec=vis_spec)

# Use the cached renderer
renderer = get_pyg_renderer()

renderer.explorer()